<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonos Dashboard - Professional Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéµ</text></svg>">
    
    <!-- Tailwind CSS config (must be before CDN script) -->
    <script>
        tailwind = window.tailwind || {};
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                        aurora: {
                            blue: '#00d4ff',
                            purple: '#b469ff',
                            green: '#00ff9d',
                            pink: '#ff6ec7',
                            cyan: '#00fff5',
                        },
                    },
                },
            },
        }
    </script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        /* Aurora Theme */
        body.theme-aurora {
            background: linear-gradient(135deg, #0a0e27 0%, #1a0e2e 25%, #0e1a2e 50%, #0a1e1a 75%, #0a0e27 100%);
            background-size: 400% 400%;
            animation: aurora-bg 60s ease infinite;
        }
        
        /* Dark Theme (Default) */
        body.theme-dark {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            background-attachment: fixed;
        }
        
        @keyframes aurora-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass-card {
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        /* Aurora Theme Glass */
        body.theme-aurora .glass-card {
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.05) 0%, 
                rgba(180, 105, 255, 0.05) 50%, 
                rgba(0, 255, 157, 0.05) 100%);
            border: 1px solid rgba(0, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
        }
        
        body.theme-aurora .glass-card:hover {
            border-color: rgba(0, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
        }
        
        /* Dark Theme Glass */
        body.theme-dark .glass-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body.theme-dark .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .gradient-primary {
            background-size: 200% 200%;
        }
        
        /* Aurora Gradient */
        body.theme-aurora .gradient-primary {
            background: linear-gradient(135deg, #00d4ff 0%, #b469ff 50%, #00ff9d 100%);
            animation: gradient-shift 10s ease infinite;
        }
        
        /* Dark Gradient */
        body.theme-dark .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #00ff9d 0%, #00fff5 100%);
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(0, 212, 255, 0.4),
                           0 0 40px rgba(180, 105, 255, 0.2),
                           0 0 60px rgba(0, 255, 157, 0.1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(0, 212, 255, 0.6),
                           0 0 60px rgba(180, 105, 255, 0.4),
                           0 0 80px rgba(0, 255, 157, 0.2);
            }
        }
        
        body.theme-aurora .playing-glow {
            animation: pulse-glow 4s ease-in-out infinite;
            border: 1px solid rgba(0, 255, 157, 0.5);
        }
        
        /* Aurora text gradient */
        .aurora-text {
            background: linear-gradient(135deg, #00d4ff 0%, #b469ff 25%, #00ff9d 50%, #ff6ec7 75%, #00fff5 100%);
            background-size: 200% 200%;
            animation: gradient-shift 15s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Aurora border animation */
        @keyframes aurora-border {
            0% { border-color: rgba(0, 212, 255, 0.3); }
            25% { border-color: rgba(180, 105, 255, 0.3); }
            50% { border-color: rgba(0, 255, 157, 0.3); }
            75% { border-color: rgba(255, 110, 199, 0.3); }
            100% { border-color: rgba(0, 212, 255, 0.3); }
        }
        
        body.theme-aurora .aurora-border {
            animation: aurora-border 15s linear infinite;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }
        
        /* Aurora scrollbar */
        body.theme-aurora ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #00d4ff 0%, #b469ff 50%, #00ff9d 100%);
            border-radius: 5px;
        }
        
        body.theme-aurora ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00fff5 0%, #ff6ec7 50%, #00d4ff 100%);
        }
        
        /* Dark scrollbar */
        body.theme-dark ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
        }
        
        body.theme-dark ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
    </style>
</head>

<body class="min-h-screen text-gray-100 antialiased" 
      x-data="dashboardApp()" 
      x-init="init()"
      :class="'theme-' + theme">

    <!-- Navigation Header with Menu -->
    <nav class="glass-card border-b aurora-border sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Left: Logo -->
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center shadow-lg">
                        <i data-lucide="radio" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold aurora-text">Sonos Dashboard</h1>
                        <p class="text-sm text-cyan-300">Network & Audio Control Center</p>
                    </div>
                </div>
                
                <!-- Right: Settings & Navigation Menu -->
                <div class="flex items-center gap-4">
                    <!-- Theme Selector -->
                    <select x-model="theme" 
                            @change="setTheme($event.target.value)"
                            class="glass-card px-4 py-2 rounded-lg text-sm border-0 focus:ring-2 focus:ring-cyan-400">
                        <option value="aurora">üåå Aurora</option>
                        <option value="dark">üåô Dark</option>
                    </select>
                    
                    <!-- Language Selector -->
                    <select x-model="language" 
                            @change="setLanguage($event.target.value)"
                            class="glass-card px-4 py-2 rounded-lg text-sm border-0 focus:ring-2 focus:ring-cyan-400">
                        <option value="en">üá¨üáß English</option>
                        <option value="zh">üáπüáº ÁπÅÈ´î‰∏≠Êñá</option>
                    </select>
                    
                    <!-- Navigation Menu Button -->
                    <div class="relative" x-data="{ menuOpen: false }" @click.away="menuOpen = false">
                        <button @click="menuOpen = !menuOpen" 
                                class="w-12 h-12 glass-card hover:bg-white/10 rounded-xl flex items-center justify-center transition-all shadow-lg hover:shadow-cyan-500/50">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div x-show="menuOpen" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 scale-95"
                             x-transition:enter-end="opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 scale-100"
                             x-transition:leave-end="opacity-0 scale-95"
                             class="absolute top-14 right-0 w-64 rounded-xl shadow-2xl border border-cyan-500/50 overflow-hidden backdrop-blur-xl"
                             style="display: none; background: rgba(15, 23, 42, 0.95);">
                            <button @click="activeTab = 'dashboard'; menuOpen = false" 
                                    :class="activeTab === 'dashboard' ? 'gradient-primary' : 'hover:bg-white/20'"
                                    class="w-full px-6 py-3 text-left font-semibold transition-all flex items-center gap-3 border-b border-white/20">
                                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                                <span x-text="t('tab_dashboard')">Dashboard</span>
                            </button>
                            <button @click="activeTab = 'controller'; menuOpen = false" 
                                    :class="activeTab === 'controller' ? 'gradient-primary' : 'hover:bg-white/20'"
                                    class="w-full px-6 py-3 text-left font-semibold transition-all flex items-center gap-3 border-b border-white/20">
                                <i data-lucide="music" class="w-5 h-5"></i>
                                <span x-text="t('tab_controller')">Controller</span>
                            </button>
                            <button @click="activeTab = 'intercom'; menuOpen = false" 
                                    :class="activeTab === 'intercom' ? 'gradient-primary' : 'hover:bg-white/20'"
                                    class="w-full px-6 py-3 text-left font-semibold transition-all flex items-center gap-3 border-b border-white/20">
                                <i data-lucide="mic" class="w-5 h-5"></i>
                                <span x-text="t('tab_intercom')">Â∞çË¨õÊ©ü</span>
                            </button>
                            <button @click="activeTab = 'assistant'; menuOpen = false" 
                                    :class="activeTab === 'assistant' ? 'gradient-primary' : 'hover:bg-white/20'"
                                    class="w-full px-6 py-3 text-left font-semibold transition-all flex items-center gap-3">
                                <i data-lucide="bot" class="w-5 h-5"></i>
                                <span x-text="t('tab_assistant')">Ë™ûÈü≥Âä©ÁêÜ</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Tab -->
    <div x-show="activeTab === 'dashboard'" x-cloak class="container mx-auto px-6 py-6 pb-12">
        <div class="grid lg:grid-cols-2 gap-6">
            
            <!-- Network Section (Left) -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="network" class="w-6 h-6 text-blue-400"></i>
                        <h2 class="text-xl font-bold" x-text="t('network_label')">Network</h2>
                    </div>
                    <button @click="scanNetwork" 
                            :disabled="scanning"
                            class="gradient-primary py-2 px-6 rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50 flex items-center gap-2">
                        <i data-lucide="scan" class="w-4 h-4"></i>
                        <span x-text="scanning ? 'Scanning...' : t('scan_btn')">Scan Network</span>
                    </button>
                </div>
                
                <!-- Summary Cards -->
                <div x-show="scanResults" class="grid grid-cols-3 gap-3 mb-4">
                    <div class="glass-card p-3 rounded-xl">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="globe" class="w-3 h-3 text-blue-400"></i>
                            <div class="text-xs text-gray-400" x-text="t('network_range')">Network</div>
                        </div>
                        <div class="text-lg font-bold text-blue-400" x-text="scanInfo.network">‚Äî</div>
                    </div>
                    <div class="glass-card p-3 rounded-xl">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="check-circle" class="w-3 h-3 text-green-400"></i>
                            <div class="text-xs text-gray-400" x-text="t('hosts_found')">Hosts Found</div>
                        </div>
                        <div class="text-lg font-bold text-green-400" x-text="scanResults">‚Äî</div>
                    </div>
                    <div class="glass-card p-3 rounded-xl">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="tag" class="w-3 h-3 text-purple-400"></i>
                            <div class="text-xs text-gray-400" x-text="t('with_hostname')">With Hostname</div>
                        </div>
                        <div class="text-lg font-bold text-purple-400" x-text="scanInfo.withHostname">‚Äî</div>
                    </div>
                </div>
                
                <!-- Host List -->
                <div x-show="scanResults && scanResults > 0" class="space-y-2 max-h-96 overflow-y-auto">
                    <template x-for="host in scanInfo.hosts" :key="host.ip">
                        <div class="glass-card p-3 rounded-lg hover:bg-white/5 transition-all">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i data-lucide="monitor" class="w-4 h-4 text-blue-400"></i>
                                        <span class="font-mono text-sm font-bold text-blue-400" x-text="host.ip"></span>
                                        <span x-show="host.hostname" 
                                              class="text-xs px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300"
                                              x-text="host.hostname"></span>
                                    </div>
                                    <div x-show="host.mac" class="flex items-center gap-2 text-xs text-gray-400">
                                        <i data-lucide="fingerprint" class="w-3 h-3"></i>
                                        <span class="font-mono" x-text="host.mac"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div x-show="!scanResults" class="text-center py-8 text-gray-400">
                    <i data-lucide="search" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                    <p class="text-sm" x-text="t('scan_prompt')">Click scan to discover devices on your network</p>
                </div>
            </div>

            <!-- Right Column: Manual PCAP Capture + PCAP Analysis -->
            <div class="space-y-6">
                
                <!-- Manual PCAP Capture (Top Right) -->
                <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center gap-3 mb-6">
                    <i data-lucide="terminal" class="w-6 h-6 text-green-400"></i>
                    <h2 class="text-xl font-bold" x-text="t('pcap_manual_title')">Manual Packet Capture</h2>
                </div>
                
                <div class="glass-card p-4 rounded-xl border-l-4 border-green-500 mb-4">
                    <p class="text-sm text-gray-300 mb-3" x-text="t('pcap_manual_intro')">Live capture disabled for security. Use the following command to capture packets:</p>
                    
                    <div class="bg-black/40 rounded-lg p-3 mb-3">
                        <code id="tcpdump_cmd" class="block text-xs text-green-400 break-all leading-relaxed font-mono">
sudo tcpdump -i en0 -s 65535 -G 5 -W 1 -w ~/Downloads/capture.pcap 'tcp port 1400 or (udp and port 1900)'
                        </code>
                    </div>
                    
                    <button onclick="copyTcpdumpCommand()" 
                            id="copy_btn"
                            class="glass-card hover:bg-green-500/20 px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 border border-green-500/30">
                        <i data-lucide="clipboard" class="w-4 h-4"></i>
                        <span id="copy_text" x-text="t('pcap_copy_btn')">Copy Command</span>
                    </button>
                    
                    <div class="mt-3 pt-3 border-t border-white/10">
                        <p class="text-xs text-gray-400 mb-2">
                            üí° <strong x-text="t('pcap_mac_hint_title')">macOS Tip:</strong>
                            <span x-text="t('pcap_mac_hint_body')">Use interface en0 (Wi‚ÄëFi) or en4 (Ethernet).</span>
                            <span x-text="t('pcap_mac_hint_param')">-G 5 means auto-stop after 5 seconds</span>
                        </p>
                        <p class="text-xs text-gray-400 leading-relaxed">
                            <strong x-text="t('pcap_steps_title')">Steps:</strong><br>
                            <span x-text="t('pcap_step_1')">1Ô∏è‚É£ Run the command in your terminal</span><br>
                            <span x-text="t('pcap_step_2')">2Ô∏è‚É£ Wait 5 seconds (or press Ctrl+C to stop early)</span><br>
                            <span x-text="t('pcap_step_3')">3Ô∏è‚É£ Upload ~/Downloads/capture.pcap below for analysis</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- PCAP Analysis (Bottom Right) -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center gap-3 mb-6">
                    <i data-lucide="package" class="w-6 h-6 text-purple-400"></i>
                    <h2 class="text-xl font-bold" x-text="t('pcap_analysis')">PCAP Analysis</h2>
                </div>
                
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div class="glass-card p-4 rounded-xl">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="network" class="w-4 h-4 text-blue-400"></i>
                            <div class="text-sm text-gray-400" x-text="t('metric_unique')">Unique Endpoints</div>
                        </div>
                        <div class="text-3xl font-bold text-blue-400" x-text="metrics.endpoints">‚Äî</div>
                        <div class="text-xs text-gray-500 mt-1" x-text="metrics.endpointsDetail">‚Äî</div>
                    </div>
                    <div class="glass-card p-4 rounded-xl">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="radio" class="w-4 h-4 text-purple-400"></i>
                            <div class="text-sm text-gray-400" x-text="t('metric_ssdp')">SSDP Messages</div>
                        </div>
                        <div class="text-3xl font-bold text-purple-400" x-text="metrics.ssdp">‚Äî</div>
                        <div class="text-xs text-gray-500 mt-1" x-text="metrics.ssdpDetail">‚Äî</div>
                    </div>
                    <div class="glass-card p-4 rounded-xl">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="activity" class="w-4 h-4 text-green-400"></i>
                            <div class="text-sm text-gray-400" x-text="t('metric_sonos')">Sonos TCP</div>
                        </div>
                        <div class="text-3xl font-bold text-green-400" x-text="metrics.sonos">‚Äî</div>
                        <div class="text-xs text-gray-500 mt-1" x-text="metrics.sonosDetail">‚Äî</div>
                    </div>
                </div>
                
                <!-- Additional Metrics Row -->
                <div class="grid md:grid-cols-4 gap-3 mb-6" x-show="metrics.hasData">
                    <div class="glass-card p-3 rounded-lg">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="hard-drive" class="w-3 h-3 text-cyan-400"></i>
                            <div class="text-xs text-gray-400" x-text="t('metric_filesize')">File Size</div>
                        </div>
                        <div class="text-lg font-bold text-cyan-400" x-text="metrics.filesize">‚Äî</div>
                    </div>
                    <div class="glass-card p-3 rounded-lg">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="package" class="w-3 h-3 text-orange-400"></i>
                            <div class="text-xs text-gray-400" x-text="t('metric_packets')">Total Packets</div>
                        </div>
                        <div class="text-lg font-bold text-orange-400" x-text="metrics.packets">‚Äî</div>
                    </div>
                    <div class="glass-card p-3 rounded-lg">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="clock" class="w-3 h-3 text-pink-400"></i>
                            <div class="text-xs text-gray-400" x-text="t('metric_duration')">Duration</div>
                        </div>
                        <div class="text-lg font-bold text-pink-400" x-text="metrics.duration">‚Äî</div>
                    </div>
                    <div class="glass-card p-3 rounded-lg">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="zap" class="w-3 h-3 text-yellow-400"></i>
                            <div class="text-xs text-gray-400" x-text="t('metric_rate')">Avg Rate</div>
                        </div>
                        <div class="text-lg font-bold text-yellow-400" x-text="metrics.rate">‚Äî</div>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button @click="analyzePcap" 
                            class="flex-1 glass-card hover:bg-white/10 py-3 px-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                        <i data-lucide="play-circle" class="w-5 h-5"></i>
                        <span x-text="t('analyze_last')">Analyze Last</span>
                    </button>
                    <label class="flex-1 glass-card hover:bg-white/10 py-3 px-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 cursor-pointer">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        <span x-text="t('upload_analyze')">Upload & Analyze</span>
                        <input type="file" @change="uploadPcap" class="hidden" accept=".pcap">
                    </label>
                </div>
            </div>
            
            </div>
            <!-- End Right Column -->

        </div>
        
        <!-- Second Row: Sonos Health & Other Features -->
        <div class="grid lg:grid-cols-4 gap-6 mt-6">

            <!-- Sonos Health -->
            <div class="glass-card rounded-2xl p-6 lg:col-span-4">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="heart-pulse" class="w-6 h-6 text-red-400"></i>
                        <h2 class="text-xl font-bold" x-text="t('sonos_health')">Sonos Health</h2>
                    </div>
                    <button @click="checkSonos" 
                            class="glass-card hover:bg-white/10 px-4 py-2 rounded-lg transition-all flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Check
                    </button>
                </div>
                
                <div id="sonos_devices" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Stream Checks -->
            <div class="glass-card rounded-2xl p-6 lg:col-span-4">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="headphones" class="w-6 h-6 text-cyan-400"></i>
                        <h2 class="text-xl font-bold">Èü≥Ê®Ç‰∏≤ÊµÅÊúçÂãôÊ™¢Ê∏¨</h2>
                    </div>
                    <button @click="checkStreams" 
                            class="glass-card hover:bg-white/10 px-4 py-2 rounded-lg transition-all flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Ê™¢Ê∏¨ÊúçÂãô
                    </button>
                </div>
                
                <div id="streams_list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Sonos Diagnostics -->
            <div class="glass-card rounded-2xl p-6 lg:col-span-4">
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <i data-lucide="wrench" class="w-6 h-6 text-orange-400"></i>
                        <h2 class="text-xl font-bold">Sonos Ë®∫Êñ∑Ëàá‰øÆÂæ©</h2>
                    </div>
                    <p class="text-sm text-gray-400">Â∏∏Ë¶ãÂïèÈ°åÂø´ÈÄü‰øÆÂæ©Â∑•ÂÖ∑</p>
                </div>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                    <button onclick="runDiagnostic('refresh')" 
                            class="glass-card hover:bg-white/10 p-4 rounded-xl transition-all flex items-center gap-3 text-left hover:shadow-lg hover:shadow-cyan-500/50">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center flex-shrink-0 shadow-lg">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-cyan-300">ÈáçÊñ∞Êï¥ÁêÜË£ùÁΩÆ</div>
                            <div class="text-xs text-gray-400">ÈáçÊñ∞Êé¢Á¥¢ÊâÄÊúâ Sonos Ë£ùÁΩÆ</div>
                        </div>
                    </button>
                    
                    <button onclick="runDiagnostic('ungroup_all')" 
                            class="glass-card hover:bg-white/10 p-4 rounded-xl transition-all flex items-center gap-3 text-left hover:shadow-lg hover:shadow-purple-500/50">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0 shadow-lg">
                            <i data-lucide="ungroup" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-purple-300">Ëß£Èô§ÊâÄÊúâÁæ§ÁµÑ</div>
                            <div class="text-xs text-gray-400">Ëß£Êï£ÊâÄÊúâÂñáÂè≠Áæ§ÁµÑ</div>
                        </div>
                    </button>
                    
                    <button onclick="runDiagnostic('mute_all')" 
                            class="glass-card hover:bg-white/10 p-4 rounded-xl transition-all flex items-center gap-3 text-left hover:shadow-lg hover:shadow-red-500/50">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-500 to-pink-500 flex items-center justify-center flex-shrink-0 shadow-lg">
                            <i data-lucide="volume-x" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-red-300">ÂÖ®ÈÉ®ÈùúÈü≥</div>
                            <div class="text-xs text-gray-400">‰∏ÄÈçµÂ∞áÊâÄÊúâÂñáÂè≠ÈùúÈü≥</div>
                        </div>
                    </button>
                    
                    <button onclick="runDiagnostic('unmute_all')" 
                            class="glass-card hover:bg-white/10 p-4 rounded-xl transition-all flex items-center gap-3 text-left hover:shadow-lg hover:shadow-green-500/50">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center flex-shrink-0 shadow-lg">
                            <i data-lucide="volume-2" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-green-300">ÂèñÊ∂àÈùúÈü≥</div>
                            <div class="text-xs text-gray-400">ÊÅ¢Âæ©ÊâÄÊúâË£ùÁΩÆÁöÑÈü≥Ë®ä</div>
                        </div>
                    </button>
                    
                    <button onclick="runDiagnostic('check_network')" 
                            class="glass-card hover:bg-white/10 p-4 rounded-xl transition-all flex items-center gap-3 text-left hover:shadow-lg hover:shadow-cyan-500/50">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-400 to-teal-500 flex items-center justify-center flex-shrink-0 shadow-lg">
                            <i data-lucide="network" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-cyan-300">Ê™¢Êü•Á∂≤Ë∑Ø</div>
                            <div class="text-xs text-gray-400">Ê∏¨Ë©¶ÊØèÂÄãË£ùÁΩÆÁöÑÈÄ£Á∑öÁãÄÊÖã</div>
                        </div>
                    </button>
                    
                    <button onclick="runDiagnostic('check_sync')" 
                            class="glass-card hover:bg-white/10 p-4 rounded-xl transition-all flex items-center gap-3 text-left hover:shadow-lg hover:shadow-yellow-500/50">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center flex-shrink-0 shadow-lg">
                            <i data-lucide="clock" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-yellow-300">Ê™¢Êü•ÂêåÊ≠•</div>
                            <div class="text-xs text-gray-400">Ê™¢Êü•Áæ§ÁµÑÂçîË™øÂô®ÁãÄÊÖã</div>
                        </div>
                    </button>
                </div>
                
                <div id="diag_status" class="glass-card p-4 rounded-xl min-h-20">
                    <p class="text-sm text-gray-400">ÈªûÊìä‰∏äÊñπË®∫Êñ∑È†ÖÁõÆ‰ª•Âü∑Ë°åÊ∏¨Ë©¶</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Controller Tab -->
    <div x-show="activeTab === 'controller'" x-cloak class="container mx-auto px-6 py-6 pb-12">
        
        <!-- Now Playing Card -->
        <div class="glass-card rounded-2xl p-8 mb-6 aurora-border" :class="nowPlaying.state === 'PLAYING' ? 'playing-glow' : ''">
            <div class="flex gap-6 items-center">
                <div class="w-32 h-32 rounded-2xl bg-gradient-to-br from-cyan-500 via-purple-500 to-green-500 flex items-center justify-center flex-shrink-0 shadow-2xl">
                    <i data-lucide="music" class="w-16 h-16"></i>
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-2">
                        <h2 class="text-3xl font-bold truncate aurora-text" x-text="nowPlaying.title || '‚Äî'">Not Playing</h2>
                        <span x-show="nowPlaying.state === 'PLAYING'" 
                              class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm font-semibold flex items-center gap-1 aurora-border">
                            <i data-lucide="play" class="w-3 h-3"></i>
                            Êí≠Êîæ‰∏≠
                        </span>
                    </div>
                    <p class="text-xl text-cyan-300 truncate mb-1" x-text="nowPlaying.artist || '‚Äî'">Artist</p>
                    <p class="text-sm text-gray-400 flex items-center gap-2">
                        <i data-lucide="speaker" class="w-4 h-4"></i>
                        <span x-text="nowPlaying.speaker || '‚Äî'">Speaker</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            
            <!-- Speaker Selection -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="speaker" class="w-6 h-6 text-blue-400"></i>
                    <h2 class="text-xl font-bold">Speakers</h2>
                </div>
                
                <div class="mb-4 p-3 glass-card rounded-lg border border-cyan-500/30">
                    <div class="text-sm text-cyan-300 font-semibold mb-1">
                        ‚úì Â∑≤ÈÅ∏Êìá: <span x-text="selectedSpeakers.length"></span> ÂÄãÂñáÂè≠
                    </div>
                    <div class="text-xs text-gray-400">
                        ÂãæÈÅ∏ÂñáÂè≠ÂæåÂç≥ÂèØÊí≠ÊîæÈü≥Ê®Ç
                    </div>
                </div>
                
                <div id="speaker_list" class="space-y-2 mb-4 max-h-80 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button @click="groupSpeakers" 
                            class="flex-1 glass-card hover:bg-white/10 py-2 px-3 rounded-lg text-sm transition-all">
                        Group
                    </button>
                    <button @click="ungroupSpeakers" 
                            class="flex-1 glass-card hover:bg-white/10 py-2 px-3 rounded-lg text-sm transition-all">
                        Ungroup
                    </button>
                </div>
            </div>

            <!-- Playback Controls -->
            <div class="glass-card rounded-2xl p-6 lg:col-span-2">
                <div class="flex items-center gap-3 mb-6">
                    <i data-lucide="sliders" class="w-6 h-6 text-purple-400"></i>
                    <h2 class="text-xl font-bold">Playback Controls</h2>
                </div>
                
                <!-- Main Controls -->
                <div class="flex justify-center items-center gap-4 mb-8">
                    <button @click="controlAction('previous')" 
                            class="w-14 h-14 glass-card hover:bg-white/10 rounded-full flex items-center justify-center transition-all hover:scale-110 hover:shadow-lg hover:shadow-cyan-500/50">
                        <i data-lucide="skip-back" class="w-6 h-6"></i>
                    </button>
                    
                    <button @click="togglePlayPause" 
                            id="play-pause-btn"
                            class="w-20 h-20 gradient-primary rounded-full flex items-center justify-center shadow-2xl shadow-purple-500/50 transition-all hover:scale-105 hover:shadow-cyan-500/70">
                                <i :data-lucide="nowPlaying.state === 'PLAYING' ? 'pause' : (nowPlaying.state === 'PAUSED_PLAYBACK' ? 'play' : 'play')" 
                                    x-text="nowPlaying.state === 'PLAYING' ? '‚è∏' : '‚ñ∂'"
                                    class="w-10 h-10 text-2xl"></i>
                    </button>
                    
                    <button @click="controlAction('next')" 
                            class="w-14 h-14 glass-card hover:bg-white/10 rounded-full flex items-center justify-center transition-all hover:scale-110 hover:shadow-lg hover:shadow-green-500/50">
                        <i data-lucide="skip-forward" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <!-- Volume Control -->
                <div class="glass-card p-4 rounded-xl">
                    <div class="flex items-center gap-4">
                        <button @click="controlAction('mute')" 
                                class="w-10 h-10 hover:bg-white/10 rounded-lg flex items-center justify-center transition-all">
                            <i data-lucide="volume-x" class="w-5 h-5"></i>
                        </button>
                        
                        <button @click="volumeDown" 
                                class="w-10 h-10 hover:bg-white/10 rounded-lg flex items-center justify-center transition-all">
                            <i data-lucide="volume-1" class="w-5 h-5"></i>
                        </button>
                        
                        <div class="flex-1 flex items-center gap-3">
                            <i data-lucide="volume-2" class="w-5 h-5 text-gray-400"></i>
                            <input type="range" 
                                   x-model="volume" 
                                   @change="setVolume"
                                   min="0" max="100" 
                                   class="flex-1 h-2 bg-white/10 rounded-full appearance-none cursor-pointer slider">
                            <span class="w-12 text-center font-bold" x-text="volume + '%'">50%</span>
                        </div>
                        
                        <button @click="volumeUp" 
                                class="w-10 h-10 hover:bg-white/10 rounded-lg flex items-center justify-center transition-all">
                            <i data-lucide="volume-2" class="w-5 h-5"></i>
                        </button>
                        
                        <button @click="controlAction('unmute')" 
                                class="w-10 h-10 hover:bg-white/10 rounded-lg flex items-center justify-center transition-all">
                            <i data-lucide="volume" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Music Search & Queue -->
            <div class="glass-card rounded-2xl p-6 lg:col-span-3">
                <div class="flex border-b border-cyan-500/20 mb-6">
                    <button @click="musicTab = 'search'" 
                            :class="musicTab === 'search' ? 'border-b-2 border-cyan-400 text-cyan-300' : 'text-gray-400'"
                            class="px-6 py-3 font-semibold transition-all flex items-center gap-2">
                        <i data-lucide="search" class="w-5 h-5"></i>
                        Search Music
                    </button>
                    <button @click="musicTab = 'queue'" 
                            :class="musicTab === 'queue' ? 'border-b-2 border-purple-400 text-purple-300' : 'text-gray-400'"
                            class="px-6 py-3 font-semibold transition-all flex items-center gap-2">
                        <i data-lucide="list-music" class="w-5 h-5"></i>
                        Queue
                    </button>
                </div>
                
                <!-- Search Tab -->
                <div x-show="musicTab === 'search'" x-cloak>
                    <div class="mb-4 text-sm text-gray-400">
                        <i data-lucide="info" class="w-4 h-4 inline"></i>
                        ÊêúÂ∞ãÊú¨Âú∞Èü≥Ê®ÇÂ∫´ÔºàNAS„ÄÅÂ™íÈ´î‰º∫ÊúçÂô®Ôºâ
                    </div>
                    
                    <div class="flex gap-3 mb-6">
                        <input type="text" 
                               x-model="searchQuery"
                               @keyup.enter="searchMusic"
                               placeholder="ÊêúÂ∞ãÊ≠åÊõ≤„ÄÅÂ∞àËºØ„ÄÅÊ≠åÊâã..."
                               class="flex-1 glass-card px-4 py-3 rounded-xl border-0 focus:ring-2 focus:ring-cyan-400">
                        
                        <button @click="searchMusic" 
                                class="gradient-primary px-6 py-3 rounded-xl font-semibold hover:shadow-lg hover:shadow-cyan-500/50 transition-all flex items-center gap-2">
                            <i data-lucide="search" class="w-5 h-5"></i>
                            ÊêúÂ∞ã
                        </button>
                        
                        <button @click="browseAllMusic" 
                                class="glass-card hover:bg-white/10 px-4 py-3 rounded-xl transition-all flex items-center gap-2 whitespace-nowrap">
                            <i data-lucide="list-music" class="w-5 h-5"></i>
                            ÁÄèË¶ΩÂÖ®ÈÉ®
                        </button>
                    </div>
                    
                    <div id="search_results" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Queue Tab -->
                <div x-show="musicTab === 'queue'" x-cloak>
                    <div class="flex gap-3 mb-6">
                        <button @click="loadQueue" 
                                class="glass-card hover:bg-white/10 px-4 py-2 rounded-lg transition-all flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Refresh
                        </button>
                    </div>
                    
                    <div id="queue_list" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Music Services Section -->
            <div class="glass-card rounded-2xl p-6 lg:col-span-4">
                <div class="flex items-center gap-3 mb-6">
                    <i data-lucide="music" class="w-6 h-6 text-orange-400"></i>
                    <h2 class="text-xl font-bold">Èü≥Ê®ÇÊúçÂãôÁÆ°ÁêÜ</h2>
                </div>
                
                <div id="music_services_list" class="mb-6 text-sm"></div>
                <button @click="showMusicServices" class="glass-card px-4 py-2 rounded-lg mb-4">È°ØÁ§∫ÂÅµÊ∏¨Âà∞ÁöÑ music_services</button>
                
                <div class="grid grid-cols-2 gap-4">
                    <button @click="addMusicService" 
                            class="flex-1 glass-card hover:bg-white/10 py-3 px-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span x-text="t('add_service')">Êñ∞Â¢ûÈü≥Ê®ÇÊúçÂãô</span>
                    </button>
                    <button @click="removeMusicService" 
                            class="flex-1 glass-card hover:bg-white/10 py-3 px-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                        <i data-lucide="minus" class="w-5 h-5"></i>
                        <span x-text="t('remove_service')">ÁßªÈô§Èü≥Ê®ÇÊúçÂãô</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Intercom Tab - Redesigned -->
    <div x-show="activeTab === 'intercom'" x-cloak class="container mx-auto px-6 py-6 pb-12">
        
        <!-- Unified Broadcast Control Panel -->
        <div class="glass-card rounded-2xl p-8">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-14 h-14 gradient-primary rounded-2xl flex items-center justify-center shadow-lg">
                    <i data-lucide="radio" class="w-7 h-7"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold aurora-text" x-text="t('intercom_title')">Ë™ûÈü≥Âª£Êí≠Á≥ªÁµ±</h2>
                    <p class="text-sm text-cyan-300" x-text="language==='zh' ? 'Âç≥ÊôÇË™ûÈü≥Âª£Êí≠ËàáÊí≠ÊîæÊéßÂà∂' : 'Real-time broadcast & playback controls'">Âç≥ÊôÇË™ûÈü≥Âª£Êí≠ËàáÊí≠ÊîæÊéßÂà∂</p>
                </div>
            </div>
            
            <div class="grid lg:grid-cols-3 gap-8">
                
                <!-- Left: Broadcast Controls -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Mode Selector: TTS or Recording -->
                    <div class="flex gap-2 mb-4">
                        <button @click="broadcastMode = 'tts'" 
                                :class="broadcastMode === 'tts' ? 'gradient-primary' : 'glass-card hover:bg-white/10'"
                                class="flex-1 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                            <i data-lucide="type" class="w-5 h-5"></i>
                            <span x-text="t('tts_mode')">ÊñáÂ≠óËΩâË™ûÈü≥</span>
                        </button>
                        <button @click="broadcastMode = 'recording'" 
                                :class="broadcastMode === 'recording' ? 'gradient-primary' : 'glass-card hover:bg-white/10'"
                                class="flex-1 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                            <span x-text="t('recording_mode')">ÈåÑÈü≥Âª£Êí≠</span>
                        </button>
                    </div>
                    
                    <!-- TTS Mode -->
                    <div x-show="broadcastMode === 'tts'" class="space-y-6">
                        <!-- Text Input -->
                        <div>
                            <label class="block text-sm font-semibold mb-3 text-gray-300 flex items-center gap-2">
                                <i data-lucide="message-square" class="w-4 h-4"></i>
                                <span x-text="t('broadcast_content_label')">Âª£Êí≠ÂÖßÂÆπ</span>
                            </label>
                            <textarea x-model="ttsText" 
                                      rows="4"
                                      class="w-full glass-card rounded-xl p-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500/50 transition-all text-lg"
                                      :placeholder="t('tts_placeholder')"></textarea>
                        </div>
                        
                        <!-- Quick Messages -->
                        <div>
                            <label class="block text-sm font-semibold mb-3 text-gray-300 flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4"></i>
                                Âø´ÈÄüË®äÊÅØ
                            </label>
                            <div class="grid grid-cols-3 gap-2">
                                <button @click="ttsText = 'ÂêÉÈ£Ø‰∫Ü'" 
                                        class="glass-card hover:bg-white/10 py-2.5 px-3 rounded-lg font-semibold transition-all text-sm">
                                    üçö ÂêÉÈ£Ø‰∫Ü
                                </button>
                                <button @click="ttsText = 'Ë©≤Áù°Ë¶∫‰∫Ü'" 
                                        class="glass-card hover:bg-white/10 py-2.5 px-3 rounded-lg font-semibold transition-all text-sm">
                                    üò¥ Ë©≤Áù°Ë¶∫‰∫Ü
                                </button>
                                <button @click="ttsText = 'Âø´‰∏ã‰æÜ'" 
                                        class="glass-card hover:bg-white/10 py-2.5 px-3 rounded-lg font-semibold transition-all text-sm">
                                    üëá Âø´‰∏ã‰æÜ
                                </button>
                                <button @click="ttsText = 'Âá∫ÈñÄÂõâ'" 
                                        class="glass-card hover:bg-white/10 py-2.5 px-3 rounded-lg font-semibold transition-all text-sm">
                                    üöó Âá∫ÈñÄÂõâ
                                </button>
                                <button @click="ttsText = 'Êúâ‰∫∫ÊåâÈñÄÈà¥'" 
                                        class="glass-card hover:bg-white/10 py-2.5 px-3 rounded-lg font-semibold transition-all text-sm">
                                    üîî ÊúâÈñÄÈà¥
                                </button>
                                <button @click="ttsText = 'Ê∞¥ÊîæÂ•Ω‰∫Ü'" 
                                        class="glass-card hover:bg-white/10 py-2.5 px-3 rounded-lg font-semibold transition-all text-sm">
                                    üõÅ Ê∞¥Â•Ω‰∫Ü
                                </button>
                            </div>
                        </div>
                        
                        <!-- Language & Speed for TTS -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-gray-300">Ë™ûË®Ä</label>
                                <select x-model="ttsLanguage" 
                                        class="w-full glass-card rounded-xl p-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500/50 cursor-pointer">
                                    <option value="zh-TW">‰∏≠Êñá</option>
                                    <option value="en">English</option>
                                    <option value="ja">Êó•Êñá</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-gray-300">ÈÄüÂ∫¶</label>
                                <select x-model="ttsSlow" 
                                        class="w-full glass-card rounded-xl p-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500/50 cursor-pointer">
                                    <option :value="false">Ê≠£Â∏∏</option>
                                    <option :value="true">ÊÖ¢ÈÄü</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recording Mode -->
                    <div x-show="broadcastMode === 'recording'" class="space-y-6">
                        <!-- Recording Control -->
                        <div class="glass-card rounded-xl p-6 border-2 border-pink-500/30">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="mic" class="w-6 h-6 text-pink-400"></i>
                                    <h3 class="text-lg font-bold">ÈåÑÈü≥ÊéßÂà∂</h3>
                                </div>
                                <span x-show="isRecording" class="flex items-center gap-2 text-red-400 font-semibold">
                                    <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                                    ÈåÑÈü≥‰∏≠
                                </span>
                            </div>
                            
                            <div class="text-center py-8">
                                <div x-show="!isRecording && !recordedAudio" class="space-y-4">
                                    <i data-lucide="mic" class="w-16 h-16 mx-auto text-gray-400"></i>
                                    <p class="text-gray-400" x-text="language==='zh' ? 'ÈªûÊìä‰∏ãÊñπÊåâÈàïÈñãÂßãÈåÑÈü≥' : 'Click button below to start recording'">ÈªûÊìä‰∏ãÊñπÊåâÈàïÈñãÂßãÈåÑÈü≥</p>
                                </div>
                                
                                <div x-show="isRecording" class="space-y-4">
                                    <div class="w-24 h-24 mx-auto gradient-primary rounded-full flex items-center justify-center animate-pulse">
                                        <i data-lucide="mic" class="w-12 h-12"></i>
                                    </div>
                                    <p class="text-xl font-bold" x-text="recordingTime + 's'">0s</p>
                                </div>
                                
                                <div x-show="recordedAudio && !isRecording" class="space-y-4">
                                    <i data-lucide="check-circle" class="w-16 h-16 mx-auto text-green-400"></i>
                                    <p class="text-green-400 font-semibold" x-text="t('recording_finished')">ÈåÑÈü≥ÂÆåÊàê</p>
                                    <audio id="audioPlayback" controls class="w-full mt-4"></audio>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <button x-show="!isRecording && !recordedAudio" 
                                        @click="startRecording"
                                        class="flex-1 gradient-primary py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="circle" class="w-5 h-5"></i>
                                    <span x-text="t('start_recording')">ÈñãÂßãÈåÑÈü≥</span>
                                </button>
                                
                                <button x-show="isRecording" 
                                        @click="stopRecording"
                                        class="flex-1 glass-card hover:bg-red-500/20 py-3 rounded-xl font-semibold transition-all border border-red-500/30 flex items-center justify-center gap-2">
                                    <i data-lucide="square" class="w-5 h-5"></i>
                                    <span x-text="t('stop_recording')">ÂÅúÊ≠¢ÈåÑÈü≥</span>
                                </button>
                                
                                <button x-show="recordedAudio && !isRecording" 
                                        @click="startRecording"
                                        class="flex-1 glass-card hover:bg-white/10 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                    ÈáçÊñ∞ÈåÑÈü≥
                                </button>
                                
                                <button x-show="recordedAudio && !isRecording" 
                                        @click="clearRecording"
                                        class="flex-1 glass-card hover:bg-red-500/20 py-3 rounded-xl font-semibold transition-all border border-red-500/30 flex items-center justify-center gap-2">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    Âà™Èô§
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Common Settings -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- Speaker Selector -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-300">ÈÅ∏ÊìáÂñáÂè≠</label>
                            <select x-model="broadcastSpeaker" 
                                    @change="updateBroadcastStatus"
                                    class="w-full glass-card rounded-xl p-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500/50 cursor-pointer">
                                <option value="" x-text="language==='zh' ? '-- ÈÅ∏ÊìáË¶ÅÂª£Êí≠ÁöÑÂñáÂè≠ --' : '-- Select speaker for broadcast --'">-- ÈÅ∏ÊìáË¶ÅÂª£Êí≠ÁöÑÂñáÂè≠ --</option>
                                <template x-for="speaker in players" :key="speaker.ip">
                                    <option :value="speaker.ip" x-text="`${speaker.name} (${speaker.ip})`"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Volume -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-300 flex items-center justify-between">
                                <span x-text="t('broadcast_volume')">Âª£Êí≠Èü≥Èáè</span>
                                <span class="text-pink-400" x-text="ttsVolume + '%'">40%</span>
                            </label>
                            <div class="glass-card p-3 rounded-xl">
                                <input type="range" 
                                       x-model="ttsVolume" 
                                       min="20" max="80" step="5"
                                       class="w-full h-2 bg-white/10 rounded-full appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Broadcast Button -->
                    <button @click="broadcastContent" 
                            :disabled="!canBroadcast() || isUploading"
                            class="w-full gradient-primary py-5 rounded-2xl font-bold text-xl flex items-center justify-center gap-3 transition-all shadow-lg hover:shadow-pink-500/50 disabled:opacity-50 disabled:cursor-not-allowed"
                            :class="!canBroadcast() || isUploading ? 'opacity-50' : 'hover:scale-[1.02]'">
                        <i data-lucide="send" class="w-7 h-7"></i>
                        <span x-text="getBroadcastButtonText()"></span>
                    </button>
                    
                    <!-- Upload Progress Bar -->
                    <div x-show="isUploading" class="glass-card rounded-xl p-4" x-cloak>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold flex items-center gap-2">
                                <i data-lucide="upload" class="w-4 h-4 text-pink-400"></i>
                                ‰∏äÂÇ≥‰∏≠...
                            </span>
                            <span class="text-sm font-bold text-pink-400" x-text="uploadProgress + '%'">0%</span>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-pink-500 to-purple-500 h-full rounded-full transition-all duration-300"
                                 :style="`width: ${uploadProgress}%`"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Current Playing & Live Control -->
                <div class="space-y-6">
                    
                    <!-- Current Playing Status -->
                    <div class="glass-card rounded-2xl p-6 border-2"
                         :class="broadcastStatus.isPlaying ? 'border-pink-500 playing-glow' : 'border-transparent'">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="activity" class="w-5 h-5 text-pink-400"></i>
                            <h3 class="text-lg font-bold">Êí≠ÊîæÁãÄÊÖã</h3>
                        </div>
                        
                        <div x-show="!broadcastStatus.isPlaying" class="text-center py-8 text-gray-400">
                            <i data-lucide="radio" class="w-12 h-12 mx-auto mb-3 opacity-30"></i>
                            <p class="text-sm" x-text="t('no_broadcast_yet')">Â∞öÊú™ÈñãÂßãÂª£Êí≠</p>
                        </div>
                        
                        <div x-show="broadcastStatus.isPlaying" class="space-y-4">
                            <!-- Speaker Info -->
                            <div class="glass-card p-4 rounded-xl">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400" x-text="t('broadcast_speaker_label')">Âª£Êí≠ÂñáÂè≠</span>
                                    <span class="px-2 py-1 bg-pink-500/20 text-pink-300 rounded-full text-xs font-semibold flex items-center gap-1">
                                        <i data-lucide="radio" class="w-3 h-3"></i>
                                        Êí≠Êîæ‰∏≠
                                    </span>
                                </div>
                                <div class="font-bold text-lg aurora-text" x-text="broadcastStatus.speakerName">--</div>
                            </div>
                            
                            <!-- Live Volume Control -->
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-gray-300 flex items-center justify-between">
                                    <span>Âç≥ÊôÇÈü≥Èáè</span>
                                    <span class="text-cyan-400" x-text="broadcastStatus.currentVolume + '%'">--</span>
                                </label>
                                <div class="glass-card p-3 rounded-xl">
                                    <input type="range" 
                                           x-model="broadcastStatus.currentVolume"
                                           @input="adjustLiveVolume"
                                           min="0" max="100" step="5"
                                           :disabled="!broadcastStatus.isPlaying"
                                           class="w-full h-2 bg-white/10 rounded-full appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                                </div>
                            </div>
                            
                            <!-- Playback Controls -->
                            <div class="flex gap-3">
                                <button @click="pauseBroadcast" 
                                        :disabled="!broadcastStatus.isPlaying || broadcastStatus.isPaused"
                                        class="flex-1 glass-card hover:bg-white/10 py-3 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    <i data-lucide="pause" class="w-5 h-5"></i>
                                    Êö´ÂÅú
                                </button>
                                <button @click="resumeBroadcast" 
                                        :disabled="!broadcastStatus.isPlaying || !broadcastStatus.isPaused"
                                        class="flex-1 glass-card hover:bg-white/10 py-3 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    <i data-lucide="play" class="w-5 h-5"></i>
                                    ÁπºÁ∫å
                                </button>
                            </div>
                            
                            <button @click="stopBroadcast" 
                                    class="w-full glass-card hover:bg-red-500/20 py-3 rounded-xl font-semibold transition-all border border-red-500/30 hover:border-red-500/60 flex items-center justify-center gap-2">
                                <i data-lucide="square" class="w-5 h-5"></i>
                                <span x-text="t('stop_broadcast')">ÂÅúÊ≠¢Âª£Êí≠</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- File Management -->
                    <div class="glass-card rounded-xl p-4 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="folder" class="w-5 h-5 text-purple-400"></i>
                                <h3 class="font-bold">Ê™îÊ°àÁÆ°ÁêÜ</h3>
                            </div>
                            <button @click="loadAudioFiles" 
                                    class="text-xs glass-card hover:bg-white/10 px-3 py-1 rounded-lg transition-all">
                                <i data-lucide="refresh-cw" class="w-3 h-3 inline"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400">TTS Ê™îÊ°à</span>
                                <span class="font-bold text-cyan-400" x-text="audioFiles.tts.length">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400">ÈåÑÈü≥Ê™îÊ°à</span>
                                <span class="font-bold text-pink-400" x-text="audioFiles.recordings.length">0</span>
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t border-white/10">
                                <span class="text-gray-400">Á∏ΩË®à</span>
                                <span class="font-bold text-purple-400" x-text="audioFiles.tts.length + audioFiles.recordings.length">0</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <button @click="showFileManager = true" 
                                    class="flex-1 glass-card hover:bg-white/10 py-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1">
                                <i data-lucide="list" class="w-3 h-3"></i>
                                ÁÄèË¶Ω
                            </button>
                            <button @click="clearAllFiles" 
                                    class="flex-1 glass-card hover:bg-red-500/20 py-2 rounded-lg text-xs font-semibold transition-all border border-red-500/30 flex items-center justify-center gap-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                Ê∏ÖÁ©∫
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Info -->
                    <div class="glass-card rounded-xl p-4 border-l-4 border-cyan-500">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                            <div class="text-sm text-gray-300 space-y-1">
                                <p x-text="t('tip_select_speaker')">‚úì ÈÅ∏Êìá‰∏ÄÂÄãÂñáÂè≠ÈÄ≤Ë°åÂª£Êí≠</p>
                                <p x-text="t('tip_adjust_volume')">‚úì Âª£Êí≠ÊôÇÂèØÂç≥ÊôÇË™øÊï¥Èü≥Èáè</p>
                                <p>‚úì ÊîØÊè¥Êö´ÂÅú/ÁπºÁ∫åÊí≠Êîæ</p>
                                <p>üìÅ Ê™îÊ°àÂ≠òÊñº data/tts Âíå data/recordings</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Voice Assistant Tab -->
    <div x-show="activeTab === 'assistant'" x-cloak class="container mx-auto px-6 py-6 pb-12">
        
        <!-- Voice Assistant Panel -->
        <div class="glass-card rounded-2xl p-8">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-14 h-14 gradient-primary rounded-2xl flex items-center justify-center shadow-lg">
                    <i data-lucide="bot" class="w-7 h-7"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold aurora-text" x-text="t('assistant_title')">AI Ë™ûÈü≥Âä©ÁêÜ</h2>
                    <p class="text-sm text-cyan-300" x-text="t('assistant_subtitle')">Ë™ûÈü≥ÊèêÂïè ¬∑ AI Â∞çË©± ¬∑ Sonos Êí≠Êîæ</p>
                </div>
            </div>
            
            <div class="grid lg:grid-cols-3 gap-8">
                
                <!-- Left: Conversation Interface -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Chat History -->
                    <div class="glass-card rounded-xl p-6 h-96 overflow-y-auto" id="chatHistory">
                        <div x-show="chatHistory.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400">
                            <i data-lucide="message-circle" class="w-16 h-16 mb-4 opacity-30"></i>
                            <p class="text-lg font-semibold mb-2">ÈñãÂßãÂ∞çË©±</p>
                            <p class="text-sm">ÈåÑÈü≥ÊèêÂïèÊàñËº∏ÂÖ•ÊñáÂ≠óËàá AI Âä©ÁêÜÂ∞çË©±</p>
                        </div>
                        
                        <div class="space-y-4">
                            <template x-for="(msg, index) in chatHistory" :key="index">
                                <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                    <div :class="msg.role === 'user' ? 'bg-cyan-500/20 border-cyan-500/30' : 'bg-purple-500/20 border-purple-500/30'" 
                                         class="max-w-[80%] rounded-xl p-4 border">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i :data-lucide="msg.role === 'user' ? 'user' : 'bot'" class="w-4 h-4"></i>
                                            <span class="text-xs font-semibold text-gray-400" x-text="msg.timestamp"></span>
                                        </div>
                                        <p class="text-sm whitespace-pre-wrap" x-text="msg.content"></p>
                                        <div x-show="msg.isPlaying" class="mt-2 flex items-center gap-2 text-xs text-green-400">
                                            <i data-lucide="volume-2" class="w-3 h-3"></i>
                                            <span>Êí≠Êîæ‰∏≠...</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Input Methods -->
                    <div class="flex gap-2 mb-4">
                        <button @click="assistantMode = 'voice'" 
                                :class="assistantMode === 'voice' ? 'gradient-primary' : 'glass-card hover:bg-white/10'"
                                class="flex-1 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                            <span x-text="t('voice_question')">Ë™ûÈü≥ÊèêÂïè</span>
                        </button>
                        <button @click="assistantMode = 'text'" 
                                :class="assistantMode === 'text' ? 'gradient-primary' : 'glass-card hover:bg-white/10'"
                                class="flex-1 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                            <i data-lucide="keyboard" class="w-5 h-5"></i>
                            <span x-text="t('text_input')">ÊñáÂ≠óËº∏ÂÖ•</span>
                        </button>
                    </div>
                    
                    <!-- Voice Input -->
                    <div x-show="assistantMode === 'voice'" class="glass-card rounded-xl p-6">
                        <div class="text-center py-8">
                            <div x-show="!isAssistantRecording && !assistantAudio" class="space-y-4">
                                <i data-lucide="mic" class="w-16 h-16 mx-auto text-gray-400"></i>
                                <p class="text-gray-400" x-text="t('press_to_speak')">Êåâ‰ΩèÊåâÈàïË™™Ë©±ÊèêÂïè</p>
                            </div>
                            
                            <div x-show="isAssistantRecording" class="space-y-4">
                                <div class="w-24 h-24 mx-auto gradient-primary rounded-full flex items-center justify-center animate-pulse">
                                    <i data-lucide="mic" class="w-12 h-12"></i>
                                </div>
                                <p class="text-xl font-bold" x-text="assistantRecordingTime + 's'">0s</p>
                                <p class="text-sm text-cyan-400" x-text="t('listening')">Ê≠£Âú®ËÅÜËÅΩ...</p>
                            </div>
                            
                            <div x-show="assistantAudio && !isAssistantRecording" class="space-y-4">
                                <i data-lucide="check-circle" class="w-16 h-16 mx-auto text-green-400"></i>
                                <p class="text-green-400 font-semibold" x-text="t('recording_finished')">ÈåÑÈü≥ÂÆåÊàê</p>
                                <audio id="assistantAudioPlayback" controls class="w-full mt-4"></audio>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button x-show="!isAssistantRecording && !assistantAudio" 
                                    @click="startAssistantRecording"
                                    class="flex-1 gradient-primary py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2">
                                <i data-lucide="mic" class="w-6 h-6"></i>
                                <span x-text="t('press_to_speak')">Êåâ‰ΩèË™™Ë©±</span>
                            </button>
                            
                            <button x-show="isAssistantRecording" 
                                    @click="stopAssistantRecording"
                                    class="flex-1 glass-card hover:bg-red-500/20 py-4 rounded-xl font-bold text-lg border border-red-500/30 flex items-center justify-center gap-2">
                                <i data-lucide="square" class="w-6 h-6"></i>
                                <span x-text="t('stop_recording')">ÂÅúÊ≠¢ÈåÑÈü≥</span>
                            </button>
                            
                            <button x-show="assistantAudio && !isAssistantRecording" 
                                    @click="sendVoiceQuestion"
                                    :disabled="isProcessing"
                                    class="flex-1 gradient-primary py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 disabled:opacity-50">
                                <i data-lucide="send" class="w-6 h-6"></i>
                                <span x-text="isProcessing ? (language==='zh' ? 'ËôïÁêÜ‰∏≠...' : 'Processing...') : t('send_voice')">ÁôºÈÄÅÊèêÂïè</span>
                            </button>
                            
                            <button x-show="assistantAudio && !isAssistantRecording" 
                                    @click="clearAssistantRecording"
                                    class="glass-card hover:bg-white/10 py-4 px-6 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                <span x-text="t('delete_recording')" class="hidden sm:inline">Âà™Èô§ÈåÑÈü≥</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Text Input -->
                    <div x-show="assistantMode === 'text'" class="space-y-4">
                        <textarea x-model="assistantTextInput" 
                                  rows="4"
                                  class="w-full glass-card rounded-xl p-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all text-lg"
                                  placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÂïèÈ°å..."></textarea>
                        
                        <button @click="sendTextQuestion" 
                                :disabled="!assistantTextInput.trim() || isProcessing"
                                class="w-full gradient-primary py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="send" class="w-6 h-6"></i>
                            <span x-text="isProcessing ? (language==='zh' ? 'ËôïÁêÜ‰∏≠...' : 'Processing...') : t('send_text')">ÁôºÈÄÅÂïèÈ°å</span>
                        </button>
                    </div>
                </div>
                
                <!-- Right: Settings & Status -->
                <div class="space-y-6">
                    
                    <!-- AI Settings -->
                    <div class="glass-card rounded-xl p-6">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="settings" class="w-5 h-5 text-purple-400"></i>
                            <h3 class="text-lg font-bold" x-text="t('ai_settings')">AI Ë®≠ÂÆö</h3>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-gray-300" x-text="t('speech_language')">Ë™ûÈü≥Ë™ûË®Ä</label>
                                <select x-model="assistantLanguage" 
                                        class="w-full glass-card rounded-xl p-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 cursor-pointer">
                                    <option value="zh">‰∏≠Êñá</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-gray-300" x-text="t('reply_voice')">ÂõûË¶ÜË™ûÈü≥</label>
                                <select x-model="assistantVoice" 
                                        class="w-full glass-card rounded-xl p-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 cursor-pointer">
                                    <option value="zh-TW">‰∏≠ÊñáÔºàÂè∞ÁÅ£Ôºâ</option>
                                    <option value="en">English</option>
                                    <option value="ja">Êó•Êñá</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-gray-300" x-text="t('play_speaker')">Êí≠ÊîæÂñáÂè≠</label>
                                <select x-model="assistantSpeaker" 
                                        class="w-full glass-card rounded-xl p-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 cursor-pointer">
                                    <option value="">‰∏çËá™ÂãïÊí≠Êîæ</option>
                                    <template x-for="speaker in players" :key="speaker.ip">
                                        <option :value="speaker.ip" x-text="speaker.name"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-gray-300 flex items-center justify-between">
                                    <span x-text="t('volume_label')">Èü≥Èáè</span>
                                    <span class="text-purple-400" x-text="assistantVolume + '%'">50%</span>
                                </label>
                                <input type="range" 
                                       x-model="assistantVolume" 
                                       min="20" max="80" step="5"
                                       class="w-full h-2 bg-white/10 rounded-full appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="glass-card rounded-xl p-4 border-l-4 border-green-500">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5"></i>
                            <div class="text-sm text-gray-300 space-y-1">
                                <p x-text="t('status_whisper')">üé§ Ë™ûÈü≥ËΩâÊñáÂ≠óÔºàWhisper APIÔºâ</p>
                                <p x-text="t('status_chatgpt')">ü§ñ AI Â∞çË©±ÔºàChatGPT APIÔºâ</p>
                                <p x-text="t('status_tts')">üîä ÊñáÂ≠óËΩâË™ûÈü≥ÔºàgTTSÔºâ</p>
                                <p x-text="t('status_sonos')">üì¢ Sonos Ëá™ÂãïÊí≠Êîæ</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="flex gap-2">
                        <button @click="clearChatHistory" 
                                class="flex-1 glass-card hover:bg-red-500/20 py-2 rounded-lg text-sm font-semibold transition-all border border-red-500/30">
                            <i data-lucide="trash-2" class="w-4 h-4 inline"></i> <span x-text="t('clear_chat')">Ê∏ÖÈô§Â∞çË©±</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- File Manager Modal -->
    <div x-show="showFileManager" 
         x-cloak
         @click.self="showFileManager = false"
         class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-6">
        <div class="glass-card rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden border border-cyan-500/30"
             style="background: rgba(15, 23, 42, 0.95);"
             @click.stop>
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <i data-lucide="folder-open" class="w-6 h-6 text-purple-400"></i>
                    <h2 class="text-2xl font-bold">Èü≥Ë®äÊ™îÊ°àÁÆ°ÁêÜ</h2>
                </div>
                <button @click="showFileManager = false" 
                        class="w-10 h-10 glass-card hover:bg-white/10 rounded-lg transition-all flex items-center justify-center">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <!-- TTS Files -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i data-lucide="type" class="w-5 h-5 text-cyan-400"></i>
                            TTS Ê™îÊ°à (<span x-text="audioFiles.tts.length">0</span>)
                        </h3>
                        <button @click="deleteFilesByType('tts')" 
                                :disabled="audioFiles.tts.length === 0"
                                class="text-xs glass-card hover:bg-red-500/20 px-3 py-1 rounded-lg transition-all border border-red-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="trash-2" class="w-3 h-3 inline"></i> Ê∏ÖÈô§ÂÖ®ÈÉ®
                        </button>
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="file in audioFiles.tts" :key="file.name">
                            <div class="glass-card p-3 rounded-lg hover:bg-white/5 transition-all">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="file-audio" class="w-4 h-4 text-cyan-400 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-mono truncate" x-text="file.name"></div>
                                        <div class="text-xs text-gray-400">
                                            <span x-text="file.size"></span> ‚Ä¢ <span x-text="file.date"></span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        <button @click="playAudioFile('tts', file.name)" 
                                                class="w-8 h-8 glass-card hover:bg-green-500/20 rounded-lg transition-all flex items-center justify-center"
                                                title="Êí≠Êîæ">
                                            <i data-lucide="play" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="renameFile('tts', file.name)" 
                                                class="w-8 h-8 glass-card hover:bg-blue-500/20 rounded-lg transition-all flex items-center justify-center"
                                                title="ÈáçÊñ∞ÂëΩÂêç">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="deleteFile('tts', file.name)" 
                                                class="w-8 h-8 glass-card hover:bg-red-500/20 rounded-lg transition-all flex items-center justify-center"
                                                title="Âà™Èô§">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="audioFiles.tts.length === 0" class="text-center py-4 text-gray-400 text-sm">
                            ÁÑ° TTS Ê™îÊ°à
                        </div>
                    </div>
                </div>
                
                <!-- Recording Files -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i data-lucide="mic" class="w-5 h-5 text-pink-400"></i>
                            ÈåÑÈü≥Ê™îÊ°à (<span x-text="audioFiles.recordings.length">0</span>)
                        </h3>
                        <button @click="deleteFilesByType('recordings')" 
                                :disabled="audioFiles.recordings.length === 0"
                                class="text-xs glass-card hover:bg-red-500/20 px-3 py-1 rounded-lg transition-all border border-red-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="trash-2" class="w-3 h-3 inline"></i> Ê∏ÖÈô§ÂÖ®ÈÉ®
                        </button>
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="file in audioFiles.recordings" :key="file.name">
                            <div class="glass-card p-3 rounded-lg hover:bg-white/5 transition-all">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="file-audio" class="w-4 h-4 text-pink-400 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-mono truncate" x-text="file.name"></div>
                                        <div class="text-xs text-gray-400">
                                            <span x-text="file.size"></span> ‚Ä¢ <span x-text="file.date"></span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        <button @click="playAudioFile('recordings', file.name)" 
                                                class="w-8 h-8 glass-card hover:bg-green-500/20 rounded-lg transition-all flex items-center justify-center"
                                                title="Êí≠Êîæ">
                                            <i data-lucide="play" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="renameFile('recordings', file.name)" 
                                                class="w-8 h-8 glass-card hover:bg-blue-500/20 rounded-lg transition-all flex items-center justify-center"
                                                title="ÈáçÊñ∞ÂëΩÂêç">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="deleteFile('recordings', file.name)" 
                                                class="w-8 h-8 glass-card hover:bg-red-500/20 rounded-lg transition-all flex items-center justify-center"
                                                title="Âà™Èô§">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="audioFiles.recordings.length === 0" class="text-center py-4 text-gray-400 text-sm">
                            ÁÑ°ÈåÑÈü≥Ê™îÊ°à
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Toast -->
    <div x-show="toast.show" 
         x-transition
         class="fixed bottom-6 right-6 glass-card px-6 py-4 rounded-xl shadow-2xl max-w-md z-50">
        <p x-text="toast.message" class="font-semibold"></p>
    </div>

    <script src="{{ url_for('static', filename='js/app_new.js') }}?v={{ config.get('BUILD_VERSION', '20251114') }}"></script>
    <script>
        // Copy tcpdump command function
        function copyTcpdumpCommand() {
            const cmd = document.getElementById('tcpdump_cmd').innerText.trim();
            const btn = document.getElementById('copy_btn');
            const text = document.getElementById('copy_text');
            
            navigator.clipboard.writeText(cmd).then(() => {
                text.textContent = '‚úì Â∑≤Ë§áË£Ω';
                btn.classList.add('bg-green-500/30');
                
                setTimeout(() => {
                    const lang = localStorage.getItem('lang') || 'zh';
                    text.textContent = lang === 'en' ? 'Copy Command' : 'Ë§áË£ΩÊåá‰ª§';
                    btn.classList.remove('bg-green-500/30');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                text.textContent = '‚ùå Ë§áË£ΩÂ§±Êïó';
                setTimeout(() => {
                    const lang = localStorage.getItem('lang') || 'zh';
                    text.textContent = lang === 'en' ? 'Copy Command' : 'Ë§áË£ΩÊåá‰ª§';
                }, 2000);
            });
        }
        
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Re-initialize after Alpine renders
        document.addEventListener('alpine:initialized', () => {
            setTimeout(() => lucide.createIcons(), 100);
        });
    </script>
</body>
</html>
